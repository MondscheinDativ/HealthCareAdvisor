name: PubMed Knowledge Graph Pipeline

on:
  schedule:
    - cron: '0 0 * * 2'  # 每周二 UTC 00:00 (北京时间周二8:00)
  workflow_dispatch:  # 允许手动触发

env:
  R_VERSION: '4.3.2'
  NEO4J_USER: ${{ secrets.NEO4J_USER }}
  NEO4J_PASS: ${{ secrets.NEO4J_PASS }}

jobs:
  prepare-data:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Validate data directories
        run: |
          # 检查原始数据目录是否存在
          for dir in pubmed clinical_trials; do
            target_dir="knowledge_graph/data/raw/$dir"
            if [ ! -d "$target_dir" ]; then
              echo "::error::数据目录不存在: $target_dir"
              exit 1
            fi
          done
          
          # 仅检查PubMed目录中是否有CSV文件
          if [ -z "$(find knowledge_graph/data/raw/pubmed -maxdepth 1 -type f -name '*.csv' 2>/dev/null)" ]; then
            echo "::error::PubMed目录中没有CSV文件"
            exit 1
          fi
          
          # 提示clinical_trials目录中没有CSV文件，但不终止工作流
          if [ -z "$(find knowledge_graph/data/raw/clinical_trials -maxdepth 1 -type f -name '*.csv' 2>/dev/null)" ]; then
            echo "::warning::clinical_trials目录中没有CSV文件，将跳过相关处理"
          fi

  build-kg:
    needs: prepare-data
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ env.R_VERSION }}
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libharfbuzz-dev libfribidi-dev \
            libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev
      
      - name: Install R packages
        run: |
          Rscript -e '
            # 移除disjointSet包，因为它不存在
            pkgs <- c("tidyverse", "neo4r", "future", "furrr", "digest")
            installed <- installed.packages()
            to_install <- setdiff(pkgs, rownames(installed))
            if (length(to_install) > 0) {
              install.packages(to_install, repos = "https://cloud.r-project.org", dependencies = TRUE)
            }
            
            # 检查是否有替代包可用
            if (!"igraph" %in% installed.packages()) {
              install.packages("igraph", repos = "https://cloud.r-project.org")
            }
          '
      
      - name: Create processed directory
        run: mkdir -p knowledge_graph/data/processed
      
      - name: Data cleaning and KG construction
        run: |
          # 在visualization目录执行脚本
          cd knowledge_graph/visualization
          Rscript -e "
          # 尝试加载必要的包，不依赖disjointSet
          if (!require('tidyverse')) install.packages('tidyverse')
          if (!require('neo4r')) install.packages('neo4r')
          if (!require('future')) install.packages('future')
          if (!require('furrr')) install.packages('furrr')
          if (!require('digest')) install.packages('digest')
          
          # 使用igraph作为可能的替代方案
          if (!require('igraph')) install.packages('igraph')
          
          source('data_cleaning.R')
          # 检查clinical_trials数据是否存在，存在才执行清洗
          if (length(list.files('knowledge_graph/data/raw/clinical_trials', pattern='*.csv')) > 0) {
            clean_clinical_trials()
          } else {
            message('没有找到clinical_trials CSV文件，跳过清洗步骤')
          }
          clean_pubmed_data()
          build_knowledge_graph()
          "
      
      - name: Upload processed data
        uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: knowledge_graph/data/processed/
          retention-days: 30

  report:
    needs: build-kg
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        supplement: ["维生素D3", "维生素C", "锌"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download processed data
        uses: actions/download-artifact@v4
        with:
          name: processed-data
          path: knowledge_graph/data/processed/
      
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ env.R_VERSION }}
      
      - name: Install system dependencies for reporting
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base texlive-fonts-recommended \
            texlive-fonts-extra texlive-latex-extra \
            texlive-science latexmk
      
      - name: Install R reporting packages
        run: |
          Rscript -e '
            pkgs <- c("tidyverse", "ggraph", "igraph", "ggtext", "knitr", "rmarkdown", "visNetwork", "data.table")
            installed <- installed.packages()
            to_install <- setdiff(pkgs, rownames(installed))
            if (length(to_install) > 0) {
              install.packages(to_install, repos = "https://cloud.r-project.org", dependencies = TRUE)
            }
          '
      
      - name: Generate reports
        run: |
          cd knowledge_graph/visualization
          Rscript -e "
          source('graph_visualization.R')
          visualize_core_graph(focus_supplement = '${{ matrix.supplement }}')
          source('professional_report.R')
          generate_professional_report(supplement = '${{ matrix.supplement }}')
          "
      
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.supplement }}-reports
          path: |
            knowledge_graph/visualization/${{ matrix.supplement }}_knowledge_graph.pdf
            knowledge_graph/visualization/${{ matrix.supplement }}_knowledge_graph.html
          retention-days: 7

  deploy:
    needs: report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./artifacts
          destination_dir: reports
          keep_files: true


